<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>üìö Danh s√°ch Blog</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">
<div class="container mt-4">
  <h2 class="text-center mb-4 fw-bold text-primary">üìö Danh s√°ch Blog</h2>

  <div th:if="${successMessage}" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11;">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body fw-bold">
          <span th:text="${successMessage}"></span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">

    <div class="d-flex align-items-center">
      <label class="me-2 fw-semibold">üìÅ Danh m·ª•c:</label>
      <select class="form-select" style="width: 250px"
              onchange="location.href='/blogs/category/' + this.value">
        <option value="">-- T·∫•t c·∫£ danh m·ª•c --</option>
        <option th:each="cat : ${categories}"
                th:value="${cat.id}"
                th:text="${cat.name}"
                th:selected="${selectedCategory != null and cat.id == selectedCategory.id}">
        </option>
      </select>
    </div>

<!--    //Form tim kiem blog theo tieu de-->
    <div class="d-flex align-items-center">
      <form id="searchForm" class="d-flex align-items-center" onsubmit="return false;">
        <input type="text" id="keyword" class="form-control me-2" placeholder="üîç Nh·∫≠p ti√™u ƒë·ªÅ blog...">
        <button type="submit" class="btn btn-primary">T√¨m ki·∫øm</button>
      </form>
      <a href="/categories/create" class="btn btn-outline-success">+ Th√™m Category</a>
      <a href="/categories" class="btn btn-outline-secondary">
        üìÇ Danh s√°ch Category
      </a>
      <a href="/blogs/create" class="btn btn-success ms-3">+ Vi·∫øt Blog</a>
    </div>
  </div>


  <div id="alertBox" class="alert alert-info text-center d-none"></div>

  <table class="table table-bordered table-striped shadow-sm">
    <thead class="table-primary text-center">
    <tr>
      <th>Ti√™u ƒë·ªÅ</th>
      <th>T√°c gi·∫£</th>
      <th>Danh m·ª•c</th>
      <th>Ng√†y t·∫°o</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
    </thead>
    <tbody id="blogBody">
    <tr th:each="blog : ${blogs.content}">
      <td th:text="${blog.title}"></td>
      <td th:text="${blog.author != null ? blog.author : 'Kh√¥ng r√µ'}"></td>
      <td th:text="${blog.category != null ? blog.category.name : 'Ch∆∞a c√≥'}"></td>
      <td th:text="${#temporals.format(blog.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
      <td class="text-center">
        <a th:href="@{/blogs/{id}(id=${blog.id})}" class="btn btn-sm btn-info text-white">Xem</a>
        <a th:href="@{/blogs/edit/{id}(id=${blog.id})}" class="btn btn-sm btn-warning">S·ª≠a</a>
        <a th:href="@{/blogs/delete/{id}(id=${blog.id})}" class="btn btn-sm btn-danger"
           onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a blog n√†y?')">X√≥a</a>
      </td>
    </tr>
    </tbody>
  </table>

  <div class="text-center mt-3">
    <button id="btn-more" class="btn btn-outline-primary">T·∫£i th√™m</button>
  </div>

  <div class="text-center mt-3 d-none" id="backButtonContainer">
    <button id="backButton" class="btn btn-outline-secondary">
      ‚Üê Quay l·∫°i danh s√°ch
    </button>
  </div>

  <div class="d-flex justify-content-center mt-3">
    <nav>
      <ul class="pagination">
        <li th:classappend="${!blogs.hasPrevious()} ? 'disabled'">
          <a th:href="@{/blogs(page=${blogs.number - 1})}" class="page-link">Trang tr∆∞·ªõc</a>
        </li>

        <li th:each="i : ${#numbers.sequence(0, blogs.totalPages - 1)}"
            th:classappend="${i == blogs.number} ? 'active'">
          <a th:href="@{/blogs(page=${i})}" class="page-link" th:text="${i + 1}"></a>
        </li>

        <li th:classappend="${!blogs.hasNext()} ? 'disabled'">
          <a th:href="@{/blogs(page=${blogs.number + 1})}" class="page-link">Trang sau</a>
        </li>
      </ul>
    </nav>
  </div>

</div>

<script>
  $(function () {
    const $tbody = $("#blogBody");
    const $btnMore = $("#btn-more");
    const $alertBox = $("#alertBox");
    const $searchForm = $("#searchForm");
    const $keyword = $("#keyword");
    const $backButton = $("#backButton");
    const $backContainer = $("#backButtonContainer");

    const pageSize = 5;
    let page = 0;
    let keyword = "";
    let loading = false;
    let searching = false;

    function showLoading() {
      $btnMore.prop("disabled", true).data("orig-text", $btnMore.text())
              .html(`<span class="spinner-border spinner-border-sm"></span> ƒêang t·∫£i...`);
    }
    function hideLoading() {
      $btnMore.prop("disabled", false).html($btnMore.data("orig-text") || "T·∫£i th√™m");
    }

    function escapeHtml(text) {
      if (!text) return "";
      return String(text)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    function renderRow(blog) {
      return `
        <tr>
          <td>${escapeHtml(blog.title)}</td>
          <td>${escapeHtml(blog.author || "(Kh√¥ng r√µ)")}</td>
          <td>${escapeHtml(blog.category?.name || "(Kh√¥ng c√≥)")}</td>
          <td>${blog.createdAt ? blog.createdAt.replace("T", " ") : ""}</td>
          <td class="text-center">
            <a href="/blogs/${blog.id}" class="btn btn-sm btn-info text-white">Xem</a>
            <a href="/blogs/edit/${blog.id}" class="btn btn-sm btn-warning">S·ª≠a</a>
            <a href="/blogs/delete/${blog.id}" class="btn btn-sm btn-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a blog n√†y?')">X√≥a</a>
          </td>
        </tr>`;
    }

    function display() {
      if (loading) return;
      loading = true;
      showLoading();

      const url = searching
              ? `http://localhost:8084/v1/api/blogs/search?keyword=${encodeURIComponent(keyword)}&page=${page}&size=${pageSize}`
              : `http://localhost:8084/v1/api/blogs?page=${page}&size=${pageSize}`;

      $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function (data) {
          const items = Array.isArray(data) ? data : data.content || [];

          if (page === 0 && items.length === 0) {
            $tbody.html(`<tr><td colspan="5" class="text-center text-muted">Kh√¥ng c√≥ b√†i vi·∫øt n√†o.</td></tr>`);
            $btnMore.hide();
            return;
          }

          let html = "";
          items.forEach(blog => html += renderRow(blog));
          if (page === 0) $tbody.html(html); else $tbody.append(html);

          if (items.length < pageSize || (data.totalPages && page >= data.totalPages - 1)) {
            $btnMore.hide();
          } else {
            $btnMore.show();
          }

          hideLoading();
        },
        error: function (xhr) {
          console.error(" L·ªói t·∫£i d·ªØ li·ªáu:", xhr.status, xhr.responseText);
          $alertBox.removeClass("d-none").addClass("alert-danger").text("ƒê√£ c√≥ l·ªói khi t·∫£i d·ªØ li·ªáu.");
        },
        complete: function () {
          loading = false;
        }
      });
    }

    $btnMore.on("click", function () {
      page++;
      display();
    });

    $searchForm.on("submit", function () {
      keyword = $keyword.val().trim();
      if (keyword === "") {
        $alertBox.removeClass("d-none alert-success alert-danger").addClass("alert-warning").text("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!");
        return;
      }

      searching = true;
      page = 0;
      display();
      $backContainer.removeClass("d-none");
    });

    $backButton.on("click", function () {
      keyword = "";
      searching = false;
      page = 0;
      $keyword.val("");
      $backContainer.addClass("d-none");
      display();
    });
    display();

    const toastEl = document.getElementById('successToast');
    if (toastEl) {
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }
  });
</script>

